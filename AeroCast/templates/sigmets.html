<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Turbulence Map – AeroCast</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
<div class="header-banner d-flex flex-column align-items-center justify-content-center mb-4">
    <h1 class="header-title">Global Turbulence (SIGMET)</h1>
    <p class="header-subtitle">Live SIGMET Turbulence Regions</p>
</div>

<div class="container mb-4 text-center">
    <a href="/" class="btn btn-secondary">← Back to Flight Search</a>
</div>

<div class="container">
    <div class="card-simple">
        <h5>Live Turbulence Map</h5>
        <div id="sigmet-map"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const sigmets = {{ sigmets | tojson }};
    console.log("SIGMETS LOADED:", sigmets);

    const map = L.map("sigmet-map").setView([20, 0], 2);

    L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",
        {
            attribution: "&copy; OpenStreetMap contributors &copy; CARTO",
            subdomains: "abcd",
            maxZoom: 19
        }
    ).addTo(map);


    // Get color based on hazard type + qualifier
    function getSigmetColor(hazard) {
        const h = (hazard || "").toLowerCase();

        // TURBULENCE 
        if (h.includes("turb")) return "#ff0000";

        // ICING
        if (h.includes("ice")) return "#00bfff";       // blue

        // THUNDERSTORMS
        if (h.includes("ts")) return "#ff7b00";        // orange-ish for storms

        // fallback / unknown
        return "#7ec8ff";   // light blue
    }


    // Draw polygons (supports simple AREA polygons)
    sigmets.forEach(s => {
        if (!s.coords) return;

        // Handle both AREA (single polygon) and AREAS (multiple polygon groups)
        const polygonGroups = Array.isArray(s.coords[0]) ? s.coords : [s.coords];

        polygonGroups.forEach(group => {
            if (group.length < 3) return;

            const latlngs = group.map(c => [c.lat, c.lon]);
            const color = getSigmetColor(s.hazard);

            L.polygon(latlngs, {
                color: color,
                weight: 2,
                fillOpacity: 0.25
            }).addTo(map);
        })
    });


    // Legend
    const legend = L.control({ position: "bottomleft" });

    legend.onAdd = function () {
        const div = L.DomUtil.create("div", "sigmet-legend");
        div.innerHTML = `
            <h6 style="margin-bottom:6px;">SIGMET Hazards</h6>

            <div><span class="box" style="background:#ff0000"></span> Turbulence </div>

            <div><span class="box" style="background:#00bfff"></span> Icing</div>

            <div><span class="box" style="background:#ff7b00"></span> Thunderstorms</div>

            <div><span class="box" style="background:#7ec8ff"></span> Other Hazards</div>
        `;
        return div;
    };

    legend.addTo(map);
</script>



</body>
</html>
